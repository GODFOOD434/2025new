# 消息通知系统设计

## 1. 消息类型定义

### 1.1 系统消息
- 采购订单导入通知
- 系统维护通知
- 版本更新通知

### 1.2 工作流消息
- 新任务通知
- 任务提醒（即将超时）
- 任务超时通知
- 任务完成通知
- 工作流状态变更通知

### 1.3 业务消息
- 新采购订单通知
- 供应商送货通知
- 质检结果通知
- 确认单生成通知
- 库存预警通知

## 2. 消息传递渠道

### 2.1 系统内部通知
- 系统消息中心
- 桌面弹窗提醒
- 未读消息徽标

### 2.2 外部通知
- 电子邮件
- 短信通知
- 微信企业号推送
- 钉钉/企业微信集成

## 3. 消息分发规则

### 3.1 角色订阅规则
| 消息类型 | 系统管理员 | 中心领导 | 生产组员工 | 保管员 | 质检员 | 用户单位联系人 |
|---------|-----------|---------|-----------|--------|--------|--------------|
| 采购订单导入 | ✓ | - | ✓ | - | - | - |
| 新任务通知 | - | - | ✓ | ✓ | ✓ | ✓ |
| 任务超时 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 质检不合格 | ✓ | ✓ | ✓ | - | ✓ | ✓ |
| 确认单生成 | - | - | ✓ | ✓ | ✓ | - |
| 库存预警 | ✓ | ✓ | - | ✓ | - | - |

### 3.2 个人订阅设置
- 用户可自定义接收哪些类型的消息
- 用户可设置首选通知渠道
- 用户可设置通知时间段
- 用户可设置消息优先级过滤

## 4. 消息队列设计

### 4.1 消息生产者
- 工作流引擎
- 采购订单导入服务
- 质检服务
- 库存管理服务
- 系统管理服务

### 4.2 消息队列
```
Exchange: warehouse.notification
Queues:
- warehouse.notification.system    // 系统消息
- warehouse.notification.workflow  // 工作流消息
- warehouse.notification.business  // 业务消息
```

### 4.3 消息消费者
- 系统内部通知服务
- 邮件发送服务
- 短信发送服务
- 微信推送服务
- 钉钉/企业微信推送服务

## 5. 消息格式

### 5.1 基本消息格式
```json
{
  "id": "MSG20230615001",
  "type": "WORKFLOW_TASK",
  "subType": "TASK_ASSIGNED",
  "title": "您有新的待办任务",
  "content": "采购订单 PO20230615001 需要您进行保管确认",
  "priority": "NORMAL",
  "createTime": 1623744000000,
  "expireTime": 1623830400000,
  "sender": {
    "id": 1,
    "name": "系统"
  },
  "receivers": [
    {
      "id": 101,
      "name": "张三",
      "channels": ["SYSTEM", "EMAIL", "SMS"]
    }
  ],
  "data": {
    "orderNo": "PO20230615001",
    "taskId": 1,
    "workflowInstanceId": 1,
    "url": "/workflow/task/1"
  },
  "status": "UNREAD"
}
```

### 5.2 消息模板
```
模板ID: TASK_ASSIGNED
标题模板: 您有新的${taskName}任务
内容模板: 采购订单 ${orderNo} 需要您进行${taskName}，请在${expireTime}前处理。
```

## 6. 消息处理流程

### 6.1 消息发送流程
1. 业务事件触发消息生成
2. 根据消息类型选择消息模板
3. 填充消息内容
4. 根据分发规则确定接收人
5. 发送消息到消息队列
6. 消息消费者处理消息
7. 根据接收人设置选择通知渠道
8. 发送通知
9. 更新消息状态

### 6.2 消息接收流程
1. 用户登录系统
2. 系统加载未读消息
3. 显示消息提醒
4. 用户点击查看消息
5. 标记消息为已读
6. 用户可对消息进行操作（如跳转到相关页面）

## 7. 消息管理功能

### 7.1 用户端功能
- 消息中心：查看所有消息
- 消息过滤：按类型、优先级筛选
- 消息标记：标记为已读/未读
- 消息删除：删除不需要的消息
- 消息设置：设置通知偏好

### 7.2 管理端功能
- 消息模板管理：编辑消息模板
- 消息规则配置：设置分发规则
- 消息监控：查看消息发送状态
- 消息统计：统计各类消息数量
- 手动发送：管理员手动发送系统通知
